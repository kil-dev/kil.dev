name: CI - Lighthouse

on:
  pull_request:
    branches: [main]
    paths:
      - "src/**"
      - "public/**"
      - "package.json"
      - "bun.lock"
      - "next.config.ts"
      - "tsconfig.json"
      - ".lighthouserc.json"
      - ".github/workflows/lighthouse.yml"

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  lighthouse:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Next Typegen
        run: bun run next typegen
        env:
          SKIP_ENV_VALIDATION: true

      - name: Build runtimes
        run: bun run build:runtimes

      - name: Build
        run: bun run build
        env:
          SKIP_ENV_VALIDATION: "1"
          NODE_ENV: "production"
          NEXT_TELEMETRY_DISABLED: "1"
          NEXT_PUBLIC_POSTHOG_KEY: ""
          NEXT_PUBLIC_POSTHOG_HOST: ""
          NEXT_PUBLIC_CONVEX_URL: ${{ secrets.NEXT_PUBLIC_CONVEX_URL }}

      - name: Run Lighthouse CI
        id: lhci
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}
          SKIP_ENV_VALIDATION: "1"
          NODE_ENV: "production"
          NEXT_TELEMETRY_DISABLED: "1"
          NEXT_PUBLIC_POSTHOG_KEY: ""
          NEXT_PUBLIC_POSTHOG_HOST: ""
          NEXT_PUBLIC_CONVEX_URL: ${{ secrets.NEXT_PUBLIC_CONVEX_URL }}
        run: bunx -y @lhci/cli@0.15.x autorun --config=.lighthouserc.json
